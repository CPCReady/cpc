#!/bin/bash
##--------------------------------------------------------------------------------
##
##   ▞▀▖▛▀▖▞▀▖▛▀▖        ▌      Created....: © Destroyer 2025
##   ▌  ▙▄▘▌  ▙▄▘▞▀▖▝▀▖▞▀▌▌ ▌   Description: Toolchain for Amstrad CPC.
##   ▌ ▖▌  ▌ ▖▌▚ ▛▀ ▞▀▌▌ ▌▚▄▌   Github.....: https://github.com/CPCReady
##   ▝▀ ▘  ▝▀ ▘ ▘▝▀▘▝▀▘▝▀▘▗▄▘   Doc........: https://cpcready.readthedocs.io/  
##
##-----------------------------LICENSE NOTICE--------------------------------------
##  This file is part of CPCReady Basic programation.
##  Copyright (C) 2025 Destroyer
##
##  This program is free software: you can redistribute it and/or modify
##  it under the terms of the GNU Lesser General Public License as published by
##  the Free Software Foundation, either version 3 of the License, or
##  (at your option) any later version.
##
##  This program is distributed in the hope that it will be useful,
##  but WITHOUT ANY WARRANTY; without even the implied warranty of
##  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
##  GNU Lesser General Public License for more details.
##
##  You should have received a copy of the GNU Lesser General Public License
##  along with this program.  If not, see <http://www.gnu.org/licenses/>.
##--------------------------------------------------------------------------------

# Load environment variables
if [[ -f ".dev" ]]; then
    source ".dev"
    CPCREADY_LIB="$CPCREADY_DIR/lib/cpc-common.sh"
    source "$CPCREADY_LIB"
    echo
    __cpcready_echo_yellow "******* DEV ENVIRONMENT *******"
else
    CPCREADY_DIR="$(brew --prefix)/opt/cpcready-tools"
    CPCREADY_LIB="$(brew --prefix)/opt/cpcready-tools/lib/cpc-common.sh"
    source "$CPCREADY_LIB"
fi

# Verify that at least one argument is provided
if [ $# -eq 0 ]; then
    usage
    exit 1
fi

COMMAND="$1"
case "$COMMAND" in
  ""|-h|--help)
    __cpcready_logo
    usage
    exit 0
    ;;
  -v|--version)
    __cpcready_logo
    echo "v$VERSION"
    exit 0
    ;;
  *)
    SCRIPT_PATH="$CPCREADY_DIR/lib/cpc-${COMMAND}.sh"

    # Verify that the script exists
    if [ ! -f "$SCRIPT_PATH" ]; then
        __cpcready_logo
        __cpcready_echo_red "Error: Command '$COMMAND' not found."
        usage
        exit 1
    fi
    
    # Verify that the script is executable
    if [ ! -x "$SCRIPT_PATH" ]; then
        chmod +x "$SCRIPT_PATH"
    fi

    # Execute the corresponding script with the remaining arguments
    # Use bash explicitly for greater compatibility
    export CPCREADY_DIR
    bash "$SCRIPT_PATH" "$@"
    ;;
esac

exit 0
